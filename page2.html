<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>حاسبة شراكة السيارة — أرباح شهرية متغيّرة</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af;
      --accent:#22c55e; --warn:#ef4444; --bd:#1f2937; --bd2:#334155;
      --gap:12px; --r:16px;
      /* أحجام مرِنة */
      --fs-100: clamp(12px, .85rem, .95rem);
      --fs-200: clamp(13px, .9rem, 1rem);
      --fs-300: clamp(14px, 1rem, 1.06rem);
      --fs-400: clamp(15px, 1.05rem, 1.15rem);
      --fs-500: clamp(18px, 1.2rem, 1.4rem);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--ink);font-size:var(--fs-400);line-height:1.7;-webkit-tap-highlight-color:transparent}
    .wrap{max-width:1280px;margin:24px auto;padding:clamp(12px,4vw,18px)}
    h1{font-size:var(--fs-500);margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap)}                  /* Mobile-First */
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:clamp(12px,3.2vw,16px);box-shadow:0 10px 30px #0006}
    label{display:block;font-size:var(--fs-200);color:var(--muted);margin-bottom:6px}
    input,select,textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--bd2);
      background:#0b1220;color:var(--ink);font-size:16px /* يمنع تكبير iOS */
    }
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    @media (min-width:660px){.row{grid-template-columns:1fr 1fr}}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{
      padding:12px 16px;border-radius:12px;border:1px solid var(--bd2);background:#0b1220;color:var(--ink);
      cursor:pointer;min-height:44px;font-weight:600
    }
    button.primary{background:var(--accent);border-color:#16a34a;color:#052e16}
    .muted{color:var(--muted)}
    .summary{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-top:var(--gap)}
    @media (min-width:900px){.summary{grid-template-columns:repeat(4,1fr)}}
    .pill{background:#0b1220;border:1px solid var(--bd);border-radius:14px;padding:10px;font-size:.95rem}
    .pill b{display:block;font-size:1.05rem;margin-top:2px}
    .ok{color:var(--accent)} .warn{color:var(--warn)}
    .scroll{max-height:420px;overflow:auto;border:1px solid var(--bd);border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:.92rem;min-width:720px}   /* جدول عريض يتم تمريره */
    thead th{position:sticky;top:0;background:#0b1220;border-bottom:1px solid var(--bd)}
    th,td{padding:8px 10px;border-bottom:1px dashed var(--bd);text-align:center;white-space:nowrap}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--bd2);background:#0b1220;color:var(--ink);cursor:pointer}
    .tab.active{background:#1f2937;border-color:#475569;font-weight:700}
    .tabpanes{width:100%}.pane{display:none}.pane.active{display:block}

    /* الرسوم: عمود واحد لملء العرض */
    .charts{display:grid;grid-template-columns:1fr;gap:24px}
    canvas{width:100% !important;max-width:100%;background:#0b1220;border:1px solid var(--bd);border-radius:12px}

    /* تحسينات شاشات أصغر من 380px */
    @media (max-width:380px){
      .tabs{gap:6px}
      button{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>(Vمصطفى) حاسبة شراكة السيارة — تسوية المدفوعات وتوزيع الأرباح (أرباح متغيرة)</h1>

    <div class="grid">
      <!-- المدخلات -->
      <div class="card">
        <div class="row">
          <div>
            <label>سعر السيارة الإجمالي</label>
            <input id="total" type="number" step="1" max="1842000" min="1842000" value="1842000" readonly disabled>
          </div>
          <div>
            <label>المدفوع — أنت</label>
            <input id="youPaid" type="number" step="1" value="1517000" disabled>
          </div>
        </div>

        <div class="row">
          <div>
            <label>المدفوع — أحمد</label>
            <input id="broPaid" type="number" step="1" min="325000" max="325000" readonly value="325000" disabled>
          </div>

          <div>
            <label>نسبة السداد من نصيب أحمد الشهري</label>
            <div style="position:relative">
              <input id="repayPct" type="number" step="1" min="85" max="100" value="100" style="padding-inline-end:28px">
              <span style="position:absolute;inset-inline-end:10px;inset-block-start:50%;transform:translateY(-50%);color:#fff;pointer-events:none">%</span>
            </div>
            <div class="muted" style="margin-top:6px">(% من نصيبه الشهري يُحوَّل لتسديد الفرق لك حتى ينتهي)</div>
          </div>
        </div>

        <script>
          // حارس نطاق 85–100%
          (function(){
            const el = document.getElementById('repayPct');
            el.addEventListener('input', ()=>{
              const v = parseInt(el.value||0,10);
              if(isNaN(v)) return;
              el.value = Math.max(85, Math.min(100, v));
            });
          })();
        </script>

        <div class="row">
          <div>
            <label>نسبة ملكيتك النهائية</label>
            <select id="youShare">
              <option value="0.6666667" selected>⅔ (66.6667%)</option>
              <option value="0.5">½ (50%)</option>
              <option value="0.6">3/5 (60%)</option>
              <option value="custom">مخصّص…</option>
            </select>
            <input id="youShareCustom" type="number" min="0" max="1" step="0.0001" placeholder="أدخل نسبة بين 0 و 1" style="margin-top:6px;display:none">
          </div>
          <div>
            <label>وضع الأرباح</label>
            <div class="btns" style="gap:6px">
              <label><input type="radio" name="mode" value="fixed" checked> ثابت (قيمة واحدة)</label>
              <label><input type="radio" name="mode" value="variable"> قائمة أرباح شهرية</label>
            </div>
          </div>
        </div>

        <div id="fixedBox" class="row" style="margin-top:8px">
          <div>
            <label>متوسط الربح الشهري (جنيه) — ثابت</label>
            <input id="monthlyProfit" type="number" step="1" value="70000">
          </div>
          <div>
            <label>—</label>
            <input type="text" disabled placeholder="استخدم الوضع المتغير أدناه إن رغبت">
          </div>
        </div>

        <div id="varBox" style="display:none;margin-top:8px">
          <label>قائمة الأرباح الشهرية (أدخل أرقامًا مفصولة بفواصل أو أسطر)</label>
          <textarea id="profitsList" placeholder="مثال:
65000
72000
40000, 90000
85000
..."></textarea>
          <div class="muted" style="margin-top:6px">سنستخدم الأرقام بالترتيب. لو انتهت القائمة قبل اكتمال التسوية، سنُكرّر <b>آخر رقم</b> تلقائيًا.</div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>دفعات إضافية (أحمد) بصيغة شهر:مبلغ</label>
            <textarea id="extraPayments" placeholder="مثال:
6:150000
9:80000, 12:50000"></textarea>
            <div class="muted" style="margin-top:6px">تُطبَّق الدفعة في بداية الشهر ثم يُعاد احتساب النِّسب لهذا الشهر. اتركه فارغًا إن لم توجد دفعات.</div>
          </div>
          <div>
            <label>التطبيق</label>
            <input type="text" disabled value="يُخصم أول الشهر قبل توزيع الربح">
          </div>
        </div>

        <div class="btns" style="margin-top:12px">
          <button class="primary" id="calcBtn">احسب الآن</button>
          <button id="resetBtn">إرجاع القيم الافتراضية</button>
          <button id="csvBtn">تحميل الجدول CSV</button>
        </div>

        <div class="pill" style="margin-top:10px;background:#052e16;border-color:#14532d;color:#d1fae5">
          ملاحظة: تُحسب التسوية أولًا من نصيب أحمد، وبعد اكتمالها يعود توزيع الربح الطبيعي حسب النِّسب.
        </div>
      </div>

      <!-- الملخص -->
      <div class="card">
        <div class="summary">
          <div class="pill">العادل لك (بالقيمة)<b id="youFair">—</b><span class="muted">= الإجمالي × نسبتك</span></div>
          <div class="pill">العادل لأحمد (بالقيمة)<b id="broFair">—</b><span class="muted">= الإجمالي × نسبته</span></div>
          <div class="pill">فرقك (مدفوع زيادة)<b id="youOver" class="ok">—</b><span class="muted">(+ يعني لك مستحقات)</span></div>
          <div class="pill">فرق أحمد (مدفوع أقل)<b id="broUnder" class="warn">—</b><span class="muted">(+ يعني عليه مستحقات)</span></div>
        </div>

        <div class="summary" style="margin-top:12px">
          <div class="pill">نصيبك في أول شهر<b id="youNow">—</b><span class="muted">يتضمّن السداد إن وُجد</span></div>
          <div class="pill">نصيب أحمد في أول شهر<b id="broNow">—</b><span class="muted">بعد خصم السداد</span></div>
          <div class="pill">أشهر متوقعة لإتمام التسوية<b id="monthsToSettle">—</b><span class="muted">تقديري مع الأرباح المُدخلة</span></div>
          <div class="pill">المتبقي من التسوية الآن<b id="remain">—</b><span class="muted">يُحدّث بعد الحساب</span></div>
          <div class="pill">إجمالي ما سيدفعه أحمد حتى نهاية التسوية<b id="ahmedTotal">—</b><span class="muted">= مجموع السداد التراكمي</span></div>
        </div>
      </div>
    </div>

    <!-- جدول -->
    <div class="card" style="margin-top:14px">
      <h2 style="margin:0 0 10px;font-size:1.1rem">جدول شهري تفصيلي (حتى اكتمال التسوية ثم 12 شهر إضافي)</h2>
      <div class="scroll">
        <table id="tbl">
          <thead>
            <tr>
              <th>الشهر</th><th>الربح</th><th>نصيبك الأساسي (أنت)</th><th>النصيب الأساسي (أحمد)</th>
              <th>دفعة إضافية (أحمد)</th><th>المسدّد لك من أحمد</th><th>إجمالي نصيبك</th><th>نصيب أحمد بعد السداد</th>
              <th>المتبقي من التسوية</th><th>النسبة الفعلية (قبل السداد أنت/أحمد)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">إذا كان ربح شهر = 0 فلن يحدث سداد في هذا الشهر.</div>
    </div>

    <!-- الرسوم -->
    <div class="card" style="margin-top:14px">
      <h2 style="margin:0 0 10px;font-size:1.1rem">رسوم توضيحية</h2>
      <div class="tabs">
        <button class="tab active" data-tab="own">النِّسب الفعلية</button>
        <button class="tab" data-tab="debt">المتبقي من التسوية</button>
        <button class="tab" data-tab="flow">السداد الشهري</button>
      </div>
      <div class="tabpanes">
        <div id="pane-own" class="pane active"><canvas id="ownershipChart" height="420"></canvas></div>
        <div id="pane-debt" class="pane"><canvas id="debtChart" height="420"></canvas></div>
        <div id="pane-flow" class="pane"><canvas id="flowChart" height="420"></canvas></div>
      </div>
      <div class="btns" style="margin-top:10px"><button id="jsonBtn">تنزيل المصفوفة JSON</button></div>
      <div class="muted">اختر التاب لعرض الرسم بعرض كامل — يُعاد رسمه تلقائيًا مع تغيير الحجم.</div>
    </div>
  </div>

  <script>
    (function(){
      const fmtNum = v => new Intl.NumberFormat('ar-EG').format(Math.round((+v+Number.EPSILON)));
      const $ = id => document.getElementById(id);

      const total=$("total"), youPaid=$("youPaid"), broPaid=$("broPaid"),
            monthlyProfit=$("monthlyProfit"), profitsList=$("profitsList"),
            youShareSel=$("youShare"), youShareCustom=$("youShareCustom"),
            repayPct=$("repayPct"),
            youFair=$("youFair"), broFair=$("broFair"), youOver=$("youOver"), broUnder=$("broUnder"),
            youNow=$("youNow"), broNow=$("broNow"), monthsToSettle=$("monthsToSettle"),
            remain=$("remain"), tblBody=$("tbl").querySelector("tbody");

      // تبديل وضع الأرباح
      const fixedBox=$("fixedBox"), varBox=$("varBox");
      document.querySelectorAll('input[name="mode"]').forEach(r=>{
        r.addEventListener("change",()=>{
          const mode = document.querySelector('input[name="mode"]:checked').value;
          fixedBox.style.display = (mode==="fixed")?"grid":"none";
          varBox.style.display   = (mode==="variable")?"block":"none";
          // عند التبديل على شاشة صغيرة، نضمن بقاء التخطيط عمودياً
        });
      });

      function getYouShare(){
        if(youShareSel.value==="custom"){
          const v=parseFloat(youShareCustom.value);
          if(isFinite(v)&&v>0&&v<1) return v;
          return 2/3;
        }
        return parseFloat(youShareSel.value);
      }
      youShareSel.addEventListener("change",()=> youShareCustom.style.display = youShareSel.value==="custom" ? "block":"none");

      $("resetBtn").addEventListener("click",()=>{
        total.value=1842000; youPaid.value=1517000; broPaid.value=325000; monthlyProfit.value=70000; profitsList.value="";
        youShareSel.value="0.6666667"; youShareCustom.value=""; repayPct.value=100; tblBody.innerHTML="";
        youFair.textContent=broFair.textContent=youOver.textContent=broUnder.textContent=youNow.textContent=broNow.textContent=monthsToSettle.textContent=remain.textContent="—";
        fixedBox.style.display="grid"; varBox.style.display="none";
        document.querySelector('input[name="mode"][value="fixed"]').checked=true;
      });

      function parseProfits(){
        const mode = document.querySelector('input[name="mode"]:checked').value;
        if(mode==="fixed"){ const p=+monthlyProfit.value||0; return Array(120).fill(p); }
        const raw=profitsList.value||"";
        return raw.split(/[\n,;]+/g).map(s=>s.trim()).filter(Boolean).map(Number).filter(n=>isFinite(n));
      }
      function parseExtraPayments(){
        const raw=($("extraPayments")?.value||"").trim(); if(!raw) return {};
        const map={}; raw.split(/[\n,;]+/g).map(s=>s.trim()).forEach(e=>{
          const a=e.split(':').map(x=>x.trim()); if(a.length===2){ const m=parseInt(a[0],10), amt=+a[1];
            if(Number.isInteger(m)&&m>0&&isFinite(amt)&&amt>0){ map[m]=(map[m]||0)+amt; }
          }
        }); return map;
      }

      function compute(){
        const T=+total.value||0, YP=+youPaid.value||0, BP=+broPaid.value||0;
        const ys_target=getYouShare(), bs_target=1-ys_target;
        const ys_paid=(T>0?(YP/T):ys_target), bs_paid=1-ys_paid;

        const fairYou=T*ys_target, fairBro=T*bs_target, overYou=YP-fairYou, underBro=fairBro-BP;
        const initialDebt=Math.max(0, Math.min(overYou, underBro));
        let remaining=initialDebt;

        const nf=new Intl.NumberFormat('ar-EG');
        youFair.textContent=nf.format(Math.round(fairYou))+" ج";
        broFair.textContent=nf.format(Math.round(fairBro))+" ج";
        youOver.textContent=(overYou>=0?"+":"")+nf.format(Math.round(overYou))+" ج";
        broUnder.textContent=(underBro>=0?"+":"")+nf.format(Math.round(underBro))+" ج";

        const repayRatio=Math.min(100,Math.max(0,+repayPct.value||0))/100;
        let profits=parseProfits(); const extraMap=parseExtraPayments(); if(profits.length===0) profits=[0];

        tblBody.innerHTML="";
        let month=0; const rows=[]; const MAX_AFTER=12, MAX_SAFE=3600;

        const profitAt=i => (i-1<profits.length ? profits[i-1] : profits[profits.length-1]);
        const currentShares = rem =>{
          if(initialDebt<=0) return {ys:ys_target, bs:bs_target};
          const f=Math.min(1,Math.max(0,rem/initialDebt));
          const ys_now=ys_target+(ys_paid-ys_target)*f; return {ys:ys_now, bs:1-ys_now};
        };

        while(((remaining>0)&&month<MAX_SAFE)||((remaining<=0)&&rows.filter(r=>r.after).length<MAX_AFTER)){
          month++;
          const extraPay=Math.min(remaining, Math.max(0, extraMap[month]||0)); remaining=Math.max(0, remaining-extraPay);
          const P=profitAt(month);
          const {ys:ys_eff, bs:bs_eff}=currentShares(remaining);
          const baseYou=P*ys_eff, baseBro=P*bs_eff;
          const maxRepay=Math.max(0, baseBro)*repayRatio;
          const repay=remaining>0 ? Math.min(remaining, maxRepay) : 0;
          const you=baseYou+repay, bro=baseBro-repay;
          remaining=Math.max(0, remaining-repay);

          const totalBase=baseYou+baseBro;
          const youPct=totalBase>0? (baseYou/totalBase*100).toFixed(1) : "0.0";
          const broPct=totalBase>0? (baseBro/totalBase*100).toFixed(1) : "0.0";

          rows.push({m:month,profit:P,baseYou,baseBro,prepay:extraPay,repay,you,bro,remain:remaining,youPct,broPct,after:remaining===0});

          if(remaining===0 && rows.filter(r=>r.after).length>=MAX_AFTER) break;
          if(P<=0 && remaining>0 && maxRepay<=0 && month > profits.length+24) break;
        }

        // ملخص أول شهر
        youNow.textContent = fmtNum(rows[0]?.you||0)+" ج";
        broNow.textContent = fmtNum(rows[0]?.bro||0)+" ج";

        const firstZero=rows.findIndex(r=>r.remain===0);
        const monthsActual = firstZero>=0 ? firstZero+1 : rows.length;
        const totalRepaidToSettle = rows.slice(0, monthsActual).reduce((s,r)=> s+(r.repay||0)+(r.prepay||0), 0);
        monthsToSettle.textContent = (initialDebt===0) ? "0" : (firstZero>=0? String(monthsActual) : "—");
        remain.textContent = fmtNum(remaining)+" ج";
        document.getElementById('ahmedTotal').textContent = fmtNum(totalRepaidToSettle)+" ج";

        // جدول
        tblBody.innerHTML = rows.map(r=>`
          <tr>
            <td>${r.m}</td><td>${fmtNum(r.profit)}</td><td>${fmtNum(r.baseYou)}</td><td>${fmtNum(r.baseBro)}</td>
            <td class="${r.prepay>0?'ok':''}">${r.prepay>0?fmtNum(r.prepay):"—"}</td>
            <td class="${r.repay>0?'ok':''}">${r.repay>0?fmtNum(r.repay):"—"}</td>
            <td><b>${fmtNum(r.you)}</b></td><td>${fmtNum(r.bro)}</td>
            <td class="${r.remain===0?'ok':'warn'}">${r.remain===0?"اكتملت ✅":fmtNum(r.remain)}</td>
            <td>${r.youPct}% / ${r.broPct}%</td>
          </tr>`).join("");

        // الرسم للتاب النشط فقط (مهم للموبايل حيث العرض يساوي 100%)
        const pane=document.querySelector('.tabpanes .pane.active');
        if(pane && pane.id==='pane-own') renderOwnershipChart(rows);
        else if(pane && pane.id==='pane-debt') renderDebtChart(rows);
        else renderFlowChart(rows);

        // إعادة رسم عند تغيير الحجم
        window.__lastRows = rows;
        if(!window.__resizeBound){
          window.addEventListener('resize', ()=>{
            const p=document.querySelector('.tabpanes .pane.active');
            if(window.__lastRows && p){
              if(p.id==='pane-own') renderOwnershipChart(window.__lastRows);
              else if(p.id==='pane-debt') renderDebtChart(window.__lastRows);
              else renderFlowChart(window.__lastRows);
            }
          });
          window.__resizeBound=true;
        }
        if(!window.__jsonBound){
          document.getElementById('jsonBtn').addEventListener('click',()=>downloadJSON(rows));
          window.__jsonBound=true;
        }
        return {rows};
      }

      function downloadJSON(rows){
        const blob=new Blob([JSON.stringify(rows,null,2)],{type:'application/json;charset=utf-8'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='car-partnership-matrix.json'; a.click();
      }

      // Tabs
      (function initTabs(){
        const tabs=document.querySelectorAll('.tabs .tab');
        tabs.forEach(btn=>{
          btn.addEventListener('click',()=>{
            const key=btn.dataset.tab;
            document.querySelectorAll('.tabs .tab').forEach(b=>b.classList.toggle('active', b===btn));
            document.querySelectorAll('.tabpanes .pane').forEach(p=>p.classList.toggle('active', p.id==='pane-'+key));
            if(window.__lastRows){
              if(key==='own') renderOwnershipChart(window.__lastRows);
              else if(key==='debt') renderDebtChart(window.__lastRows);
              else renderFlowChart(window.__lastRows);
            }
          });
        });
      })();

      /* ===== رسومات Canvas (بدون مكتبات) عالية الدقة ومتجاوبة ===== */
      function drawLineChart(canvasId, series, {title,yMin=null,yMax=null,formatY,valGuides}={}){
        const c=$(canvasId); const ctx=c.getContext('2d');
        const DPR=Math.max(1,window.devicePixelRatio||1);
        const cssW=c.clientWidth||900, cssH=c.height; c.width=Math.floor(cssW*DPR); c.height=Math.floor(cssH*DPR); ctx.scale(DPR,DPR);
        const padL=68,padR=28,padT=40,padB=46, W=cssW,H=cssH, left=padL,right=W-padR,top=padT,bottom=H-padB, w=right-left,h=bottom-top;
        let minY=+Infinity,maxY=-Infinity,len=0;
        series.forEach(s=>{ len=Math.max(len,s.data.length); s.data.forEach(v=>{ if(v==null)return; minY=Math.min(minY,v); maxY=Math.max(maxY,v);});});
        if(yMin!=null)minY=yMin; if(yMax!=null)maxY=yMax; if(!isFinite(minY)||!isFinite(maxY)||maxY===minY){minY=0;maxY=1;}
        const fmt=v=> formatY?formatY(v):(''+Math.round(v));

        ctx.clearRect(0,0,W,H);
        if(title){ ctx.fillStyle='#e5e7eb'; ctx.font='600 15px system-ui'; ctx.fillText(title,left,top-12); }
        ctx.strokeStyle='#334155'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(left,bottom); ctx.lineTo(right,bottom); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(left,top); ctx.lineTo(left,bottom); ctx.stroke();

        ctx.font='12px system-ui'; ctx.fillStyle='#9ca3af';
        const yTicks=6;
        for(let i=0;i<=yTicks;i++){
          const t=i/yTicks, y=bottom-t*h, val=minY+t*(maxY-minY);
          ctx.strokeStyle='#1f2937'; ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke();
          ctx.fillText(fmt(val),8,y+4);
        }
        const step=Math.max(1,Math.floor(len/10));
        for(let i=0;i<len;i+=step){
          const x=left+(i/(Math.max(1,len-1)))*w; ctx.fillText((i+1).toString(),x-6,bottom+16);
          ctx.strokeStyle='#1f2937'; ctx.beginPath(); ctx.moveTo(x,bottom); ctx.lineTo(x,bottom-4); ctx.stroke();
        }
        const xEnd=left+((len-1)/(Math.max(1,len-1)))*w; ctx.fillText(len.toString(),xEnd-6,bottom+16);

        if(valGuides){ ctx.setLineDash([6,6]); ctx.strokeStyle='#475569';
          valGuides.forEach(g=>{ const y=bottom-((g-minY)/(maxY-minY))*h; ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke();});
          ctx.setLineDash([]);
        }

        const palette=['#22c55e','#60a5fa','#f59e0b','#ef4444','#a78bfa'];
        series.forEach((s,idx)=>{
          const color=s.color||palette[idx%palette.length];
          ctx.lineWidth=2.5; ctx.strokeStyle=color; ctx.beginPath();
          s.data.forEach((v,i)=>{ const x=left+(i/(Math.max(1,len-1)))*w, y=bottom-((v-minY)/(maxY-minY))*h; if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);});
          ctx.stroke();
        });
      }

      function drawComboBarsAndLine(canvasId, bars, line, {title}={}){
        const c=$(canvasId), ctx=c.getContext('2d');
        const DPR=Math.max(1,window.devicePixelRatio||1);
        const cssW=c.clientWidth||900, cssH=c.height; c.width=Math.floor(cssW*DPR); c.height=Math.floor(cssH*DPR); ctx.scale(DPR,DPR);
        const padL=68,padR=28,padT=40,padB=46, W=cssW,H=cssH,left=padL,right=W-padR,top=padT,bottom=H-padB,w=right-left,h=bottom-top;
        const len=Math.max(bars.length,line.length); let maxY=Math.max(1, ...bars, ...line);
        ctx.clearRect(0,0,W,H); ctx.fillStyle='#e5e7eb'; ctx.font='600 15px system-ui'; ctx.fillText(title||'السداد الشهري',left,top-12);
        ctx.strokeStyle='#334155'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(left,bottom); ctx.lineTo(right,bottom); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(left,top); ctx.lineTo(left,bottom); ctx.stroke();
        ctx.font='12px system-ui'; ctx.fillStyle='#9ca3af';
        const yTicks=6, fmt=v=>new Intl.NumberFormat('ar-EG').format(Math.round(v));
        for(let i=0;i<=yTicks;i++){ const t=i/yTicks, y=bottom-t*h, val=t*maxY; ctx.strokeStyle='#1f2937'; ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke(); ctx.fillText(fmt(val),8,y+4);}
        const step=Math.max(1,Math.floor(len/10));
        for(let i=0;i<len;i+=step){ const x=left+(i/(Math.max(1,len-1)))*w; ctx.fillText((i+1).toString(),x-6,bottom+16); ctx.strokeStyle='#1f2937'; ctx.beginPath(); ctx.moveTo(x,bottom); ctx.lineTo(x,bottom-4); ctx.stroke();}
        const xEnd=left+((len-1)/(Math.max(1,len-1)))*w; ctx.fillText(len.toString(),xEnd-6,bottom+16);
        const barW=Math.max(4, w/Math.max(12,len)*0.6);
        ctx.fillStyle='#22c55e'; bars.forEach((v,i)=>{ const x=left+(i/(Math.max(1,len-1)))*w-barW/2; const y=bottom-(v/maxY)*h; ctx.fillRect(x,y,barW,bottom-y); });
        ctx.strokeStyle='#60a5fa'; ctx.lineWidth=2.5; ctx.beginPath();
        line.forEach((v,i)=>{ const x=left+(i/(Math.max(1,len-1)))*w; const y=bottom-(v/maxY)*h; if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);}); ctx.stroke();
      }

      function prepare(rows){
        return {
          youPct: rows.map(r=>parseFloat(r.youPct)),
          broPct: rows.map(r=>parseFloat(r.broPct)),
          remain: rows.map(r=>r.remain),
          repay : rows.map(r=>r.repay),
          baseBro: rows.map(r=>r.baseBro)
        };
      }
      function renderOwnershipChart(rows){
        const d=prepare(rows);
        drawLineChart('ownershipChart',[
          {name:'نسبة أنت',data:d.youPct},{name:'نسبة أحمد',data:d.broPct}
        ],{title:'تطور النِّسب الفعلية (قبل السداد)',yMin:0,yMax:100,formatY:v=>Math.round(v)+'%',valGuides:[66.7,33.3]});
      }
      function renderDebtChart(rows){ const d=prepare(rows);
        drawLineChart('debtChart',[{name:'المتبقي',data:d.remain}],{title:'المتبقي من التسوية',yMin:0,formatY:v=>new Intl.NumberFormat('ar-EG').format(Math.round(v))});
      }
      function renderFlowChart(rows){ const d=prepare(rows);
        drawComboBarsAndLine('flowChart', d.repay, d.baseBro, {title:'السداد الشهري مقابل نصيب أحمد الأساسي'});
      }

      // تصدير CSV
      $("csvBtn").addEventListener("click",()=>{
        const {rows}=compute(); if(!rows.length){alert("من فضلك احسب أولًا."); return;}
        const header=["Month","Profit","Base_You","Base_Ahmed","Repaid_to_You","You_Take","Ahmed_Take","Remaining"];
        const csv=[header.join(",")].concat(rows.map(r=>[r.m,r.profit,r.baseYou,r.baseBro,r.repay,r.you,r.bro,r.remain].join(","))).join("\n");
        const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a");
        a.href=URL.createObjectURL(blob); a.download="car-partnership-schedule-variable.csv"; a.click();
      });

      // ابدأ
      $("calcBtn").addEventListener("click", compute);
      compute();
    })();
  </script>
</body>
</html>
